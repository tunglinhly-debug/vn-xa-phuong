<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Tra cứu xã / phường Việt Nam</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px auto;
  max-width: 900px;
}
h2 { margin-bottom: 10px }
label { display:block; margin-top:14px; font-weight:bold }
select, button {
  width:100%; padding:8px; margin-top:6px; font-size:15px
}
.code-box {
  margin-top:12px; padding:10px;
  background:#f6f8fa; border-radius:6px
}
#map { margin-top:20px; height:360px; background:#eee }
.status { margin-top:10px; font-size:14px; color:#555 }
</style>
</head>

<body>

<h2>Tra cứu xã / phường Việt Nam</h2>

<label>Tỉnh / Thành phố</label>
<select id="province">
  <option>Đang tải dữ liệu...</option>
</select>

<label>Xã / Phường (mới)</label>
<select id="commune" disabled></select>

<div class="code-box">
<b>Mã hành chính</b>
<div>Tỉnh / TP: <span id="codeProvince">N/A</span></div>
<div>Xã / Phường: <span id="codeCommune">N/A</span></div>
</div>

<button onclick="exportCSV()">Xuất CSV</button>

<div id="status" class="status"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const DATA_URL =
"https://raw.githubusercontent.com/phucanhle/vn-xaphuong-2025/main/danhmucxaphuong.json";

const CACHE_KEY="VN_XA_PHUONG_CACHE_FINAL";
const CACHE_TIME="VN_XA_PHUONG_TIME_FINAL";
const EXPIRE=1000*60*60*24*7;

const province = document.getElementById("province");
const commune = document.getElementById("commune");
const codeProvince = document.getElementById("codeProvince");
const codeCommune = document.getElementById("codeCommune");
const status = document.getElementById("status");

let data = [];

/* ===== NORMALIZE THE REAL JSON SCHEMA ===== */
function normalize(raw){
  return raw.map(p => ({
    provinceName: p.tentinhmoi,
    provinceCode: p.matinhTMS || p.matinhBNV || "",
    communes: (p.phuongxa || []).map(x => ({
      communeName: x.tenphuongxa,
      communeCode: x.maphuongxa
    }))
  }));
}

/* ===== INIT PROVINCE DROPDOWN ===== */
function initProvince(){
  province.innerHTML =
    '<option value="">-- Chọn tỉnh / thành phố --</option>';
  data.forEach((p,i)=>{
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = p.provinceName;
    province.appendChild(opt);
  });
}

/* ===== LOAD DATA WITH CACHE ===== */
function loadData(){
  const cache = localStorage.getItem(CACHE_KEY);
  const time = localStorage.getItem(CACHE_TIME);

  if(cache && time && Date.now()-time < EXPIRE){
    data = JSON.parse(cache);
    status.textContent = "Đang dùng dữ liệu cache (offline OK)";
    initProvince();
  }

  fetch(DATA_URL)
    .then(r => r.json())
    .then(raw => {
      data = normalize(raw);
      localStorage.setItem(CACHE_KEY, JSON.stringify(data));
      localStorage.setItem(CACHE_TIME, Date.now());
      status.textContent = "Dữ liệu tải trực tiếp từ GitHub";
      initProvince();
    })
    .catch(err => {
      if(!cache){
        status.textContent = "Không tải được dữ liệu";
      }
      console.error(err);
    });
}

/* ===== EVENTS ===== */
province.addEventListener("change", () => {
  commune.innerHTML =
    '<option value="">-- Chọn xã / phường --</option>';
  commune.disabled = true;
  codeCommune.textContent = "N/A";

  if(province.value === ""){
    codeProvince.textContent = "N/A";
    return;
  }

  const p = data[province.value];
  codeProvince.textContent = p.provinceCode || "N/A";

  p.communes.forEach((x,i)=>{
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = x.communeName;
    commune.appendChild(opt);
  });

  commune.disabled = false;
});

commune.addEventListener("change", () => {
  if(commune.value === "") return;
  const x = data[province.value].communes[commune.value];
  codeCommune.textContent = x.communeCode || "N/A";
});

/* ===== EXPORT CSV ===== */
function exportCSV(){
  const rows = [["Tỉnh","Mã tỉnh","Xã/Phường","Mã xã"]];
  data.forEach(p=>{
    p.communes.forEach(x=>{
      rows.push([
        p.provinceName,
        p.provinceCode,
        x.communeName,
        x.communeCode
      ]);
    });
  });

  const csv = "\uFEFF" + rows.map(r=>r.join(",")).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "xa_phuong_vn.csv";
  a.click();
}

/* ===== MAP ===== */
L.map("map")
 .setView([16,108],5)
 .addLayer(
   L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
 );

loadData();
</script>

</body>
</html>
