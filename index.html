<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Tra c·ª©u x√£/ph∆∞·ªùng Vi·ªát Nam</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
  max-width: 900px;
}
h2 { margin-bottom: 10px; }
label { display: block; margin-top: 14px; font-weight: bold; }
select, button {
  width: 100%;
  padding: 8px;
  margin-top: 6px;
  font-size: 15px;
}
.highlight {
  color: #d35400;
  font-weight: bold;
}
.status {
  margin-top: 10px;
  font-size: 14px;
  color: #555;
}
.actions {
  margin-top: 16px;
  display: flex;
  gap: 10px;
}
#map {
  margin-top: 20px;
  height: 360px;
  border-radius: 8px;
  background: #eee;
}
.code-box {
  margin-top: 10px;
  padding: 8px;
  background: #f6f8fa;
  border-radius: 6px;
  font-size: 14px;
}
</style>
</head>

<body>

<h2>Tra c·ª©u x√£ / ph∆∞·ªùng Vi·ªát Nam</h2>

<label>T·ªânh / Th√†nh ph·ªë</label>
<select id="province">
  <option value="">-- ƒêang t·∫£i d·ªØ li·ªáu --</option>
</select>

<label>X√£ / Ph∆∞·ªùng m·ªõi</label>
<select id="commune" disabled>
  <option value="">-- Ch·ªçn t·ªânh tr∆∞·ªõc --</option>
</select>

<label>ƒê·ªãa ch·ªâ c≈©</label>
<select id="oldAddress" disabled>
  <option value="">-- Ch·ªçn x√£/ph∆∞·ªùng --</option>
</select>

<div class="code-box">
  <b>M√£ h√†nh ch√≠nh</b>
  <div>T·ªânh/TP: <span id="codeProvince">N/A</span></div>
  <div>X√£/Ph∆∞·ªùng: <span id="codeCommune">N/A</span></div>
</div>

<div class="actions">
  <button onclick="exportCSV()">Xu·∫•t CSV</button>
  <button onclick="exportExcel()">Xu·∫•t Excel</button>
</div>

<div id="status" class="status">ƒêang kh·ªüi t·∫°o‚Ä¶</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const DATA_URL =
  "https://raw.githubusercontent.com/phucanhle/vn-xaphuong-2025/main/danhmucxaphuong.json";

const CACHE_KEY = "VN_XA_PHUONG_CACHE_V2";
const CACHE_TIME_KEY = "VN_XA_PHUONG_CACHE_TIME";
const CACHE_EXPIRE = 1000 * 60 * 60 * 24 * 7;

let adminData = [];
let map;

function initMap() {
  try {
    map = L.map("map").setView([16.0, 108.0], 5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);
  } catch (e) {
    document.getElementById("map").innerHTML =
      "<div style='padding:10px'>Kh√¥ng t·∫£i ƒë∆∞·ª£c b·∫£n ƒë·ªì</div>";
  }
}

function setStatus(msg) {
  document.getElementById("status").textContent = msg;
}

function loadData() {
  const cached = localStorage.getItem(CACHE_KEY);
  const cacheTime = localStorage.getItem(CACHE_TIME_KEY);

  if (cached && cacheTime && Date.now() - cacheTime < CACHE_EXPIRE) {
    adminData = JSON.parse(cached);
    setStatus("ƒêang d√πng d·ªØ li·ªáu cache (offline OK)");
    initProvince();
  }

  fetch(DATA_URL)
    .then(r => r.json())
    .then(data => {
      adminData = data;
      localStorage.setItem(CACHE_KEY, JSON.stringify(data));
      localStorage.setItem(CACHE_TIME_KEY, Date.now());
      setStatus("D·ªØ li·ªáu ƒë√£ t·∫£i t·ª´ GitHub");
      initProvince();
    })
    .catch(err => {
      if (!cached) {
        setStatus("Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ GitHub");
        console.error(err);
      }
    });
}

function initProvince() {
  const sel = document.getElementById("province");
  sel.innerHTML = '<option value="">-- Ch·ªçn t·ªânh / th√†nh ph·ªë --</option>';
  adminData.forEach((p, i) => {
    sel.innerHTML += `<option value="${i}">${p.tinh}</option>`;
  });
}

province.onchange = function () {
  const cSel = commune;
  const oSel = oldAddress;

  cSel.innerHTML = '<option value="">-- Ch·ªçn x√£ / ph∆∞·ªùng m·ªõi --</option>';
  oSel.innerHTML = '<option value="">--</option>';
  cSel.disabled = oSel.disabled = true;

  document.getElementById("codeProvince").textContent =
    adminData[this.value]?.ma_tinh || "N/A";
  document.getElementById("codeCommune").textContent = "N/A";

  if (this.value === "") return;

  adminData[this.value].xa_phuong.forEach((x, i) => {
    const isMerge = x.ten_cu && x.ten_cu.includes(";");
    cSel.innerHTML +=
      `<option value="${i}" class="${isMerge ? "highlight" : ""}">
        ${x.ten_moi}${isMerge ? " üî∂" : ""}
      </option>`;
  });

  cSel.disabled = false;
};

commune.onchange = function () {
  oldAddress.innerHTML = "";
  oldAddress.disabled = true;

  if (this.value === "") return;

  const p = adminData[province.value];
  const x = p.xa_phuong[this.value];

  document.getElementById("codeCommune").textContent =
    x.ma_xa || "N/A";

  if (x.ten_cu) {
    x.ten_cu.split(";").forEach(v => {
      oldAddress.innerHTML += `<option>${v.trim()}</option>`;
    });
  }

  oldAddress.disabled = false;
};

function getFlatData() {
  const rows = [["T·ªânh/TP", "M√£ t·ªânh", "X√£/Ph∆∞·ªùng m·ªõi", "M√£ x√£", "ƒê·ªãa ch·ªâ c≈©"]];
  adminData.forEach(p => {
    p.xa_phuong.forEach(x => {
      if (!x.ten_cu) return;
      x.ten_cu.split(";").forEach(cu => {
        rows.push([
          p.tinh,
          p.ma_tinh || "",
          x.ten_moi,
          x.ma_xa || "",
          cu.trim()
        ]);
      });
    });
  });
  return rows;
}

function exportCSV() {
  const rows = getFlatData();
  const csv = "\uFEFF" + rows.map(r => r.join(",")).join("\n");
  download(csv, "xa_phuong_viet_nam.csv", "text/csv");
}

function exportExcel() {
  exportCSV();
}

function download(content, filename, type) {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

initMap();
loadData();
</script>

</body>
</html>
